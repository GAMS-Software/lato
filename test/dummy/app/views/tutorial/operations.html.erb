<%= lato_page_head 'Operazioni', [
  { label: 'Tutorial', path: tutorial_path },
  { label: 'Operazioni' }
] %>

<p>
Le operazioni sono un sistema di Lato per gestire visualmente l'esecuzione di Job in background.<br>
Le operazioni sono gestite da diverse parti:
</p>

<ul>
  <li>Il modello <code>Lato::Operation</code> inizializza tutte le operazioni e tiene traccia del loro stato di esecuzione.</li>
  <li>Il controller <code>Lato::OperationsController</code> gestisce l'accesso degli utenti ad una operazione in corso.</li>
  <li>La componente <code>lato_operation</code> permette di visualizzare a front-end lo stato di una operazione.</li>
</ul>

<h3>Convertire un Job in una operazione</h3>

<p>
Il metodo più facile per convertire un Job in una operazione è, semplicemente, fare in modo che il Job sia una sotto-classe di <code>Lato::ApplicationJob</code>.<br>
È inoltre necessario che il metodo <code>perform()</code> riceva un solo parametro Hash <code>params</code>.
</p>

<pre>
# Prima
def MyJob < ApplicationJob
  def perform(hello)
    puts hello
  end
end

# Dopo
def MyJob < Lato::ApplicationJob
  def perform(params = {})
    puts params[:hello]
  end
end
</pre>

<h3>Generare una operazione</h3>

<p>
Le operazioni possono essere generate tramite il metodo <code>generate</code> del modello <code>Lato::Operation</code>.<br>
La generazione di un'operazione richiede tre parametri: nome del job da eseguire, Hash dei parametri da passare, id dell'utente che ha richiesto la generazione.
</p>

<pre>
operation = Lato::Operation.generate('ExportProductsJob', { product_ids: [1, 2, 3] }, @session.user_id)
</pre>

<p>
Una volta generata l'operazione deve essere eseguita attraverso il metodo <code>start</code>.<br>
Di seguito un esempio di controller che avvia una operazione:
</p>

<pre>
class CustomController < ApplicationController
  def create_operation_action
    @operation = Lato::Operation.generate('OperationExampleJob', {}, @session.user_id)

    respond_to do |format|
      if @operation.start
        format.html { redirect_to lato.operations_show_path(@operation) }
        format.json { render json: @operation }
      else
        format.html { render :index, status: :unprocessable_entity }
        format.json { render json: @operation.errors, status: :unprocessable_entity }
      end
    end
  end
end
</pre>

<h3>Mostrare l'esito di una operazione</h3>

<p>
Ogni operazione può essere visualizzata nella route <code>lato.operations_show_path(operation_id)</code>.<br>
Per garantire la sicurezza dei dati un'operazione è accessibile solo per l'utente che ne ha richiesto la generazione.
</p>

<p>
Ogni operazione può avere 4 stati: <code>created</code>, <code>running</code>, <code>completed</code>, <code>failed</code>.<br>
La visualizzazione di una operazione, gestita tramite la componente <code>lato_operation</code>, mostra in real-time lo stato in cui si trova l'operazione e il relativo output.<br>
Utilizza il link di seguito per provare una operazione:
</p>

<pre>
&#60;%= link_to 'Genera operazione',
  main_app.custom_create_operation_action_path,
  data: { turbo_method: :post }
%&#62;
</pre>

<%= link_to 'Genera operazione con successo', main_app.operations_create_operation_action_path, class: 'text-success', data: { turbo_method: :post } %> |
<%= link_to 'Genera operazione con fallimento', main_app.operations_create_operation_action_path(type: :failed), class: 'text-danger', data: { turbo_method: :post } %>

<div class="alert alert-info mt-3">
  <h4 class="alert-heading">Note</h4>
  <p>
  Per visualizzare l'esito di una operazione direttamente in-page è possibile utilizzare le funzionalità di <code>lato_action_controller</code>.<br>
  Esempio:
  </p>
<pre>
&#60;%= link_to 'Genera operazione',
  main_app.custom_create_operation_action_path,
  data: { lato_action_target: 'trigger', turbo_method: :post, turbo_frame: 'lato_operation' }
%&#62;
</pre>
<%= link_to 'Genera operazione con successo', main_app.operations_create_operation_action_path, data: { lato_action_target: 'trigger', turbo_method: :post, turbo_frame: 'lato_operation' } %>
</div>